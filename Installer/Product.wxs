<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util"
     xmlns:fw="http://wixtoolset.org/schemas/v4/wxs/firewall">

  <Package Name="Zebra AirPrint Service"
           Version="1.0.0.0"
           Manufacturer="Your Company Name"
           UpgradeCode="12345678-1234-1234-1234-123456789012"
           Compressed="yes">

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Use WixUI_InstallDir to allow users to choose installation directory -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- Set default installation directory to Program Files -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="ZebraAirPrintService">
        <Directory Id="LogsFolder" Name="Logs" />
      </Directory>
    </StandardDirectory>

    <!-- Main executable component -->
    <Component Id="MainExecutable" Directory="INSTALLFOLDER" Guid="11111111-1111-1111-1111-111111111111" Bitness="always64">
      <File Source="..\publish\ZebraAirPrintService.exe" KeyPath="yes" />

      <!-- Windows Service Installation -->
      <ServiceInstall Id="ServiceInstaller"
                      Name="ZebraAirPrintService"
                      DisplayName="Zebra AirPrint Service"
                      Description="AirPrint Server fÃ¼r Zebra ZD410 Etikettendrucker"
                      Type="ownProcess"
                      Start="auto"
                      ErrorControl="normal"
                      Account="LocalSystem" />

      <ServiceControl Id="ServiceControl"
                      Name="ZebraAirPrintService"
                      Start="install"
                      Stop="both"
                      Remove="both"
                      Wait="yes" />

      <!-- Configure service recovery on failure -->
      <util:ServiceConfig ServiceName="ZebraAirPrintService"
                         FirstFailureActionType="restart"
                         SecondFailureActionType="restart"
                         ThirdFailureActionType="restart"
                         RestartServiceDelayInSeconds="5" />
    </Component>

    <!-- Configuration file -->
    <Component Id="ConfigFile" Directory="INSTALLFOLDER" Guid="22222222-2222-2222-2222-222222222222" Bitness="always64">
      <File Source="..\publish\appsettings.json" KeyPath="yes" />
    </Component>

    <!-- Logs directory -->
    <Component Id="LogsDirectory" Directory="LogsFolder" Guid="33333333-3333-3333-3333-333333333333" Bitness="always64">
      <CreateFolder />
      <RemoveFolder Id="RemoveLogsFolder" On="uninstall" />
      <RemoveFile Id="RemoveLogFiles" Name="*.*" On="uninstall" />
      <RegistryValue Root="HKCU"
                     Key="Software\[Manufacturer]\[ProductName]"
                     Name="LogsFolder"
                     Type="string"
                     Value="[LogsFolder]"
                     KeyPath="yes" />
    </Component>

    <!-- Firewall rule for IPP (port 631) -->
    <Component Id="FirewallIPP" Directory="INSTALLFOLDER" Guid="44444444-4444-4444-4444-444444444444" Bitness="always64">
      <fw:FirewallException Id="FW_IPP"
                            Name="Zebra AirPrint Service - IPP"
                            Port="631"
                            Protocol="tcp"
                            Scope="any" />
      <RegistryValue Root="HKCU"
                     Key="Software\[Manufacturer]\[ProductName]"
                     Name="FirewallIPP"
                     Type="integer"
                     Value="1"
                     KeyPath="yes" />
    </Component>

    <!-- Firewall rule for mDNS (port 5353) -->
    <Component Id="FirewallMDNS" Directory="INSTALLFOLDER" Guid="55555555-5555-5555-5555-555555555555" Bitness="always64">
      <fw:FirewallException Id="FW_MDNS"
                            Name="Zebra AirPrint Service - mDNS"
                            Port="5353"
                            Protocol="udp"
                            Scope="any" />
      <RegistryValue Root="HKCU"
                     Key="Software\[Manufacturer]\[ProductName]"
                     Name="FirewallMDNS"
                     Type="integer"
                     Value="1"
                     KeyPath="yes" />
    </Component>

    <!-- Feature definition -->
    <Feature Id="MainFeature">
      <ComponentRef Id="MainExecutable" />
      <ComponentRef Id="ConfigFile" />
      <ComponentRef Id="LogsDirectory" />
      <ComponentRef Id="FirewallIPP" />
      <ComponentRef Id="FirewallMDNS" />
    </Feature>

    <!-- Custom actions for URL ACL configuration -->
    <CustomAction Id="ConfigureUrlAcl"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  ExeCommand="[SystemFolder]cmd.exe /c &quot;netsh http add urlacl url=http://+:631/ user=EVERYONE&quot;" />

    <CustomAction Id="RemoveUrlAcl"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  ExeCommand="[SystemFolder]cmd.exe /c &quot;netsh http delete urlacl url=http://+:631/&quot;" />

    <!-- Custom action to stop service and kill orphaned processes before uninstall -->
    <CustomAction Id="StopServiceAndProcesses"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  ExeCommand="[SystemFolder]WindowsPowerShell\v1.0\powershell.exe -NoProfile -ExecutionPolicy Bypass -Command &quot;Stop-Service -Name 'ZebraAirPrintService' -Force -ErrorAction SilentlyContinue; Start-Sleep -Seconds 2; Get-Process -Name 'ZebraAirPrintService' -ErrorAction SilentlyContinue | Stop-Process -Force&quot;" />

    <!-- Custom action to clean up old installation paths -->
    <CustomAction Id="CleanupOldPaths"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  ExeCommand="[SystemFolder]WindowsPowerShell\v1.0\powershell.exe -NoProfile -ExecutionPolicy Bypass -Command &quot;if (Test-Path 'C:\AirPrintService') { Remove-Item -Path 'C:\AirPrintService' -Recurse -Force -ErrorAction SilentlyContinue }&quot;" />

    <!-- Custom action to remove HKLM registry entries -->
    <CustomAction Id="CleanupHKLMRegistry"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  ExeCommand="[SystemFolder]WindowsPowerShell\v1.0\powershell.exe -NoProfile -ExecutionPolicy Bypass -Command &quot;Remove-Item -Path 'HKLM:\Software\ZebraAirPrintService' -Recurse -Force -ErrorAction SilentlyContinue&quot;" />

    <InstallExecuteSequence>
      <Custom Action="ConfigureUrlAcl" Before="InstallFinalize" Condition="NOT Installed" />
      <!-- Stop service and kill processes before removing service -->
      <Custom Action="StopServiceAndProcesses" Before="DeleteServices" Condition="REMOVE~=&quot;ALL&quot;" />
      <!-- Remove URL ACL before removing files -->
      <Custom Action="RemoveUrlAcl" Before="RemoveFiles" Condition="REMOVE~=&quot;ALL&quot;" />
      <!-- Clean up HKLM registry and old paths -->
      <Custom Action="CleanupHKLMRegistry" Before="RemoveFiles" Condition="REMOVE~=&quot;ALL&quot;" />
      <Custom Action="CleanupOldPaths" Before="RemoveFiles" Condition="REMOVE~=&quot;ALL&quot;" />
    </InstallExecuteSequence>

    <!-- UI Reference -->
    <ui:WixUI Id="WixUI_InstallDir" xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui" />

  </Package>
</Wix>
